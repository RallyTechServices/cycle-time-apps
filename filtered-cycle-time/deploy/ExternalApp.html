<!DOCTYPE html>
<html>
<head>
    <title>Filtered Cycle Time</title>
    <!--  (c) 2014 Rally Software Development Corp.  All Rights Reserved. -->
    <!--  Build Date: Wed Feb 04 2015 13:43:24 GMT-0700 (MST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Wed Feb 04 2015 13:43:24 GMT-0700 (MST)";
        var CHECKSUM = [%= checksum %];
    </script>
    
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc3/sdk-debug.js?apiKey=_PUT_APIKEY_HERE_"></script>

    <script type="text/javascript">
        Rally.onReady(function() {
             
/**
 * A link that pops up a version dialog box
 */

Ext.define('Rally.technicalservices.InfoLink',{
    extend: 'Ext.Component',
    alias: 'widget.tsinfolink',
    
    /**
     * @cfg {String} informationHtml
     * Additional text to be displayed on the popup dialog (for exmaple,
     * to add a description of the app's use or functionality)
     */
    informationHtml: null,
    
    /**
     * 
     * cfg {String} title
     * The title for the dialog box
     */
     title: "Build Information",
    
    renderTpl: "<div id='{id}-infolinkWrap' class='tsinfolink'>i</div>",

    initComponent: function() {
        this.callParent(arguments);
       
    },
    
    onRender: function() {
        this.callParent(arguments);
        this.mon(this.el,'click',this.onClick,this);
    },
    _generateChecksum: function(string){
        var chk = 0x12345678,
            i;
        string = string.replace(/var CHECKSUM = .*;/,"");
        string = string.replace(/\s/g,"");  //Remove all whitespace from the string.
        
        for (i = 0; i < string.length; i++) {
            chk += (string.charCodeAt(i) * i);
        }
    
        return chk;
    },
    _checkChecksum: function(container) {
        var me = this;
        Ext.Ajax.request({
            url: document.URL,
            params: {
                id: 1
            },
            success: function (response) {
                text = response.responseText;
                if ( CHECKSUM ) {
                    if ( CHECKSUM !== me._generateChecksum(text) ) {
                        console.log("Checksums don't match!");
                        if ( me.dialog ) {
                            me.dialog.add({xtype:'container',html:'Checksums do not match'});
                        }
                    }
                }
            }
        });
    },
    onClick: function(e) {
        var me = this;
        this._checkChecksum(this);
        
        var dialog_items = [];
        
        if ( this.informationHtml ) {
            dialog_items.push({
                xtype:'container',
                html: this.informationHtml
            });
        }
                
        dialog_items.push({
            xtype:'container',
            html:"This app was created by the Rally Technical Services Team."
        });
        
        if ( APP_BUILD_DATE ) {
            dialog_items.push({
                xtype:'container',
                html:'Build date/time: ' + APP_BUILD_DATE
            });
        }
        
        if (this.dialog){this.dialog.destroy();}
        this.dialog = Ext.create('Rally.ui.dialog.Dialog',{
            defaults: { padding: 5, margin: 5 },
            closable: true,
            draggable: true,
            title: me.title,
            items: dialog_items
        });
        this.dialog.show();
    }
});

/*
 */
Ext.define('Rally.technicalservices.Logger',{
    constructor: function(config){
        Ext.apply(this,config);
    },
    log: function(args){
        var timestamp = "[ " + Ext.util.Format.date(new Date(), "Y-m-d H:i:s.u") + " ]";
        //var output_args = arguments;
        //output_args.unshift( [ "[ " + timestamp + " ]" ] );
        //output_args = Ext.Array.push(output_args,arguments);
        
        var output_args = [];
        output_args = Ext.Array.push(output_args,[timestamp]);
        output_args = Ext.Array.push(output_args, Ext.Array.slice(arguments,0));

        window.console && console.log.apply(console,output_args);
    }

});

Ext.define('CycleCalculator', {
    extend: 'Rally.data.lookback.calculator.BaseCalculator',
    config: {
        cycleField: 'ScheduleState',
        cycleStartValue: 'Defined',
        cycleEndValue: 'Accepted',
        cyclePrecedence: [],
        startDate: null,
        endDate: null,
        granularity: "month",
        dateFormat: "M yyyy",
        dataFilters: []
    },
    runCalculation: function(snapshots) {
         var snaps_by_oid = Rally.technicalservices.Toolbox.aggregateSnapsByOid(snapshots);

         var date_buckets = Rally.technicalservices.Toolbox.getDateBuckets(this.startDate, this.endDate, this.granularity);

         var cycle_time_data = [];
         console.log(snaps_by_oid);
         Ext.Object.each(snaps_by_oid, function(oid, snaps){
             var ctd = this._getCycleTimeData(snaps, this.cycleField, this.cycleStartValue, this.cycleEndValue, this.cyclePrecedence);
             if (ctd.include){
                 cycle_time_data.push(ctd);
             }
         },this);
         
         var series = [];
         series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity));  
         series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity,'HierarchicalRequirement'));  
         series.push(this._getSeries(cycle_time_data, date_buckets, this.granularity,'Defect'));  
         
         categories = Rally.technicalservices.Toolbox.formatDateBuckets(date_buckets,this.dateFormat);
         
         return {
            series: series,
            categories: categories
        }
    },
    
    _getCycleTimeData: function(snaps, field, startValue, endValue, precedence){
        var start_index = -1;  
        if (startValue != null){  //This is in case there is no start value (which means grab the first snapshot)
            var start_index = _.indexOf(precedence, startValue);
        }
        var end_index = _.indexOf(precedence, endValue);

        var include = false; 
        
        //Assumes snaps are stored in ascending date order.  
        var start_date = null, end_date = null, between_states = false, days = null; 
        var type = snaps[0]._TypeHierarchy.slice(-1)[0];
        Ext.each(snaps, function(snap){
            var state_index = -1;  
            if (snap[field]){
                state_index = _.indexOf(precedence, snap[field]);
            }
            if (state_index >= start_index && start_date == null){
                start_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);  
                between_states = true;  
            }
            
            if (between_states && state_index >= end_index){
                end_date = Rally.util.DateTime.fromIsoString(snap._ValidFrom);
                if (start_date != null){
                    days = Rally.util.DateTime.getDifference(end_date,start_date,"day");
                }
                between_states = false;  
                include = this._snapMeetsFilterCriteria(snap);
            }
            
        }, this);
        
        return {days: days, endDate: end_date, startDate: start_date, artifactType: type, include: include };
    },
    _snapMeetsFilterCriteria: function(snap){
        console.log('_snapMeetsFilterCriteria', this.dataFilters);
        var is_filtered = true;
        
        Ext.each(this.dataFilters, function(filter){
            console.log(filter);
            var str_format = "{0} {1} {2}";
            if (isNaN(snap[filter.property]) && isNaN(filter.value)){
                str_format = "\"{0}\" {1} \"{2}\"";
            }
            var operator = filter.operator;
            if (operator == "="){
                operator = "==";
            }
            var str_eval = Ext.String.format(str_format, snap[filter.property], operator, filter.value);
            is_filtered = eval(str_eval);
            console.log(str_eval, is_filtered);
            return is_filtered;
        },this);
        
        return is_filtered;  
    },
    _getSeries: function(cycle_time_data, date_buckets, granularity, type){
        var series_raw_data = [];
        var series_data = [];
        for (var i=0; i<date_buckets.length; i++){
            series_raw_data[i] = [];
            series_data = 0;
        }
        
        Ext.each(cycle_time_data, function(cdata){
            for (var i=0; i<date_buckets.length; i++){
                if ((type == undefined || type == cdata.artifactType) && cdata.endDate >= date_buckets[i] && cdata.endDate < Rally.util.DateTime.add(date_buckets[i],granularity,1)){
                    series_raw_data[i].push(cdata.days)
                }
            }
        });

        var series_data = new Array(series_raw_data.length);
        _.map(series_data, function(){return null});
        for (var i=0; i<series_raw_data.length; i++){
            if (series_raw_data[i].length > 0){
                series_data[i] = Ext.Array.mean(series_raw_data[i]);
            } else {
                series_data[i]=null;
            }
        }

        return {
             name: this._getSeriesName(type),
             data: series_data,
             display: 'line'
         };
    },
    _getSeriesName: function(type){
        var type_text = "Combined";
        if (type) {
            type_text = type;
            if (type == 'HierarchicalRequirement'){
                type_text = "User Story";
            }
        }
        return Ext.String.format(type_text);   
    }
});
Ext.define('Rally.technicalservices.dialog.Filter',{
    extend: Rally.ui.dialog.Dialog,
    autoShow: true,
    componentCls: "rly-popover dark-container",
    validFields: [],
    initComponent: function() {
        this.items = this._getItems();
        this.buttons = this._getButtonConfig();
        this.callParent(arguments);
        this._addNewRow();
        this.addEvents(
                'customFilter'
        );
    },
    _getItems: function() {
        return [{
            xtype: "container",
            cls: "custom-filter-header",
            layout: "column",
            defaults: {
                xtype: "component",
                cls: "filter-panel-label"
            },
            items: [{
                height: 1,
                width: 30
            }, {
                html: "Field",
                width: 155
            }, {
                html: "Operator",
                width:  80
            }, {
                html: "Value",
                width:  155
            }]
        }, {
            xtype: "container",
            itemId: "customFilterRows"
        },{
            xtype: "container",
            itemId: 'ct-footer',
            items: [{
                xtype:'rallybutton',
                text: '+',
                margin: 5,
                scope: this,
                handler: this._addNewRow
            }]
        }]
    },
    _getFieldStore: function(){
        //Return a store that includes filterable fields but
        //excludes the field 
        return Ext.create('Rally.data.custom.Store',{
            data: this.validFields
        });
    },
    _getOperatorStore: function(ct){
        console.log('bubble',ct);
        if (ct && ct.itemId && ct.itemId == 'ct-row'){
            var operator_store = ["="];
            var rec = ct.down('#cb-filter-field').getRecord(); 
            ct.down('#cb-filter-operator').destroy(); 
            ct.down('#cb-filter-value').destroy(); 
            console.log('attributetype', ct.down('#cb-filter-field').getRecord().get('RealAttributeType'));
            if (ct.down('#cb-filter-field').getRecord().get('AttributeType') == 'QUANTITY'){
                 operator_store = ["=",">","<",">=","<="];
                 
                 ct.add({
                     xtype: "rallycombobox",
                     itemId: 'cb-filter-operator',
                     store: operator_store,
                     margin: 5,
                     width: 80,
                     allowNoEntry: true,
                     noEntryText: ''
                 });
                 ct.add({
                     xtype: "rallynumberfield",
                     itemId: 'cb-filter-value',
                     margin: 5,
                     width: 80,
                     allowBlank: true,
                     
                 });
            } else {
                ct.add({
                    xtype: "rallycombobox",
                    itemId: 'cb-filter-operator',
                    store: operator_store,
                    margin: 5,
                    width: 80,
                    allowNoEntry: true,
                    noEntryText: '',
                    noEntryValue: null
                    
                });

                ct.add({
                    xtype: 'rallyfieldvaluecombobox',
                    itemId: 'cb-filter-value',
                    model: 'HierarchicalRequirement',
                    field: rec.get('ElementName'),
                    margin: 5,
                    allowNoEntry: true,
                    noEntryText: '',
                    noEntryValue: null
                });
               
            }
             

        }
    },
    _addNewRow: function() {

        var field_store = this._getFieldStore();
        
        this.down('#customFilterRows').add({
            xtype: "container",
            layout: {type: 'hbox'},
            itemId: 'ct-row',
            items: [{
                xtype: "rallybutton",
                text: '-',
                scope: this,
                margin: 5
            },{
                xtype: "rallycombobox",
                itemId: 'cb-filter-field',
                store: field_store,
                valueField: 'ElementName',
                listeners: {
                    scope: this,
                    select: function(cb){
                        cb.bubble(this._getOperatorStore)
                    }
                },
                allowNoEntry: true,
                noEntryText: 'Choose Field...',
                noEntryValue: null,
                margin: 5,
                value: null
            },{
                xtype: "rallycombobox",
                itemId: 'cb-filter-operator',
                store: [],
                margin: 5,
                width: 80
            },{
                xtype: "rallycombobox",
                itemId: 'cb-filter-value',
                store: [],
                margin: 5
            }],
        })
    },
    _getButtonConfig: function() {
        return [{
            xtype: "rallybutton",
            itemId: "cancelButton",
            cls: "secondary rly-small",
            text: "Cancel",
            handler: this._onCancelClick,
            scope: this
        }, {
            xtype: "rallybutton",
            itemId: "applyButton",
            cls: "primary rly-small",
            text: "Apply",
            handler: this._onApplyClick,
            scope: this
        }]
    },
    _onCancelClick: function() {
        this.destroy()
    },
    _validateItem: function(item){
        return true;  
    },
    _onApplyClick: function() {
        var filters = [];  
        console.log(this.down('#customFilterRows').down('ct-row'));
        Ext.each(this.down('#customFilterRows').items.items, function(item){
             if (this._validateItem(item)){
                 console.log('item',item);
                 property = item.down('#cb-filter-field').getValue();
                 operator = item.down('#cb-filter-operator').getValue();
                 val = item.down('#cb-filter-value').getValue(); 
                 
                 if (property && operator && val) {
                     filters.push({
                         property: property,
                         operator: operator,
                         value: val
                     });
                 }
                 
             }
        }, this);

        this.fireEvent("customfilter", filters);
        this.destroy()
    },
});
    Ext.override(Rally.ui.chart.Chart, {

        onRender: function () {
            if (this.loadMask) {
                this.getEl().mask('Loading...');
            }
            this.callParent(arguments);
        },

        constructor: function (config) {
            this.callParent(arguments);
            this._loadExternalDependencies();
        },

        _onAfterLoadDependencies: function () {
            if (!this._validateConfiguration()) {
                return this._unmask();
            }

            // Chart colors config array likes to be passed around by reference and bleed
            // into other charts.
            this.chartColors = Ext.Array.clone(this.chartColors);

            var chartConfig = this.getChartConfig() || {};
            this._setChartConfigDefaults(chartConfig);

            this._callUpdateBeforeRender();

            this.fireEvent('storesConfigured', this);

            if(this.chartData) {
                this._renderChart();
            } else {
                this._setUpCalculator();
                this._loadStores();
            }
        },

        _callUpdateBeforeRender: function () {
            if (typeof this.updateBeforeRender === 'function') {
                this.updateBeforeRender.apply(this);
            }
        },

        _setUpCalculator: function () {
            this.calculator = Ext.create(this.getCalculatorType(), this.getCalculatorConfig());
        },

        _validateConfiguration: function () {
            var requiredConfigs = ['storeConfig', 'storeType', 'calculatorType', 'calculatorConfig', 'chartConfig'];
            if(this.chartData) {
                // If chart data is provided, you do not need the store/calculator information
                return true;
            }
            for (var i = 0; i < requiredConfigs.length; i++) {
                var configField = requiredConfigs[i];
                if (!this[configField]) {
                    return this._setErrorMessage("Missing required configuration field: " + configField);
                }
            }
            return true;
        },

        /**
         * Loop over the given store configs and load them. Because we have the ability to
         * handle multiple stores we need to load each one and check if all of them have
         * been loaded as each one finishes pulling data.
         * @private
         */
        _loadStores: function () {
            this._wrapStores();

            this.loadedStores = [];
            this.queryValid = true;
            this.workspaceHalted = false;
            this.serviceUnavailable = false;

            for (var i = 0; i < this.storeConfig.length; i++) {
                this._loadStore(this.storeConfig[i], i);
            }
        },

        _loadStore: function (storeConfig, storeRank) {
            var self = this;

            Ext.merge(storeConfig, {
                exceptionHandler: function (proxy, response, operation) {
                    if (response.status !== 200) {
                        self.queryValid = false;
                    }

                    if (response.status === 409) {
                        self.workspaceHalted = true;
                    } else if (response.status === 503) {
                        self.serviceUnavailable = true;
                    }
                }
            });

            storeConfig.limit = storeConfig.limit || Infinity;

            var store = Ext.create(this.storeType, storeConfig);
            store.rank = storeRank;

            store.on('load', this._storeLoadHandler, this);
            store.load();
        },

        _storeLoadHandler: function (store) {
            this.loadedStores.push(store);
            if (this.loadedStores.length === this.storeConfig.length) {
                this._onStoresLoaded();
            }
        },

        _setErrorMessage: function (message) {
            this.down('#chart').add({
                xtype: 'displayfield',
                itemId: 'error',
                value: message
            });
            this._setChartReady();
            return false;
        },

        _setChartReady: function () {
            this.componentReady = true;
            this._callUpdateAfterRender();
        },

        _callUpdateAfterRender: function () {
            if ('function' === typeof this.updateAfterRender) {
                this.updateAfterRender.apply(this);
            }
        },

        _onStoresLoaded: function () {
            this.fireEvent('storesLoaded', this);
            this._unmask();

            if (this.serviceUnavailable) {
                return this._setErrorMessage(this.serviceUnavailableErrorMessage);
            }
            if (this.workspaceHalted) {
                return this._setErrorMessage(this.haltedWorkspaceErrorMessage);
            }
            if (!this.queryValid) {
                return this._setErrorMessage(this.authorizationErrorMessage);
            }
            if (this._noDataLoaded()) {
                return this._setErrorMessage(this.queryErrorMessage);
            }

            Ext.Array.sort(this.loadedStores, function (left, right) {
                return left.rank - right.rank;
            });

            this._unWrapStores();

            this.fireEvent('storesValidated', this);
            this.chartData = this.calculator.prepareChartData(this.loadedStores);
            this.fireEvent('snapshotsAggregated', this);

            this.fireEvent('readyToRender', this);
            this._validateAggregation();
            this.fireEvent('chartRendered', this);
        },

        _wrapStores: function () {
            if (!Ext.isArray(this.storeConfig)) {
                this.storeConfig = [this.storeConfig];
            }
        },

        _unWrapStores: function () {
            if (this.loadedStores.length === 1) {
                this.loadedStores = this.loadedStores[0];
            }
        },

        _noDataLoaded: function () {
            for (var i = 0; i < this.loadedStores.length; i++) {
                var store = this.loadedStores[i];
                if (store.getCount() > 0) {
                    return false;
                }
            }
            return true;
        },

        _unmask: function () {
            if (this.loadMask && this.getEl()) {
                this.getEl().unmask();
            }
        },

        _validateAggregation: function () {
            if (!this._haveDataToRender()) {
                return this._setErrorMessage(this.aggregationErrorMessage);
            }

            this._renderChart();
        },

        _isData: function(point) {
            return point > 0;
        },

        _haveDataToRender: function () {
            var seriesData = this.chartData.series;

            for (var i = 0, ilength = seriesData.length; i < ilength; i++) {
                var data = seriesData[i].data;

                for (var j = 0, jlength = data.length; j < jlength; j++) {
                    if (this._isData(data[j])) {
                        return true;
                    } else if(Ext.isArray(data[j]) && _.some(data[j], this._isData)) {
                        return true;
                    }
                }
            }
        },

        _renderChart: function () {
            this._unmask();

            var chartConfig = this.getChartConfig(),
                chartEl = this.down('#chart');

            if (chartEl) {
                chartConfig.xAxis = chartConfig.xAxis || {};
                chartConfig.xAxis.categories = this.chartData.categories;

                this._setChartColorsOnSeries(this.chartData.series);

                var highChartConfig = {
                    xtype: 'highchart',
                    chartConfig: chartConfig,
                    series: this.chartData.series,
                    initAnimAfterLoad: false
                };

                chartEl.add(highChartConfig);
                this._setChartReady();
            }
        },

        _setChartColorsOnSeries: function (series) {
            var colors = this.chartColors,
                length = Math.min(series.length, colors.length);

            for (var i = 0; i < length; i += 1) {
                series[i].color = colors[i];
            }
        }
    });
Ext.define('Rally.technicalservices.Toolbox',{
    singleton: true,
    /**
     * Returns beginnig of month as date for the current time zone
     * 
     */
    getBeginningOfMonthAsDate: function(dateInMonth){
        var year = dateInMonth.getFullYear();
        var month = dateInMonth.getMonth();
        return new Date(year,month,1,0,0,0,0);
    },
    getEndOfMonthAsDate: function(dateInMonth){
        var year = dateInMonth.getFullYear();
        var month = dateInMonth.getMonth();
        var day = new Date(year, month+1,0).getDate();
        return new Date(year,month,day,0,0,0,0);
    },
    aggregateSnapsByOid: function(snaps){
        //Return a hash of objects (key=ObjectID) with all snapshots for the object
        var snaps_by_oid = {};
        Ext.each(snaps, function(snap){
            var oid = snap.ObjectID || snap.get('ObjectID');
            if (snaps_by_oid[oid] == undefined){
                snaps_by_oid[oid] = [];
            }
            snaps_by_oid[oid].push(snap);
            
        });
        return snaps_by_oid;
    },
    getCaseInsensitiveKey: function(obj, inputStr){
        var new_key = inputStr;
        Ext.Object.each(obj, function(key, val){
            if (new_key.toLowerCase() == key.toLowerCase()){
                new_key = key;  
            }
         });
        return new_key;

    },
    aggregateSnapsByOidForModel: function(snaps){
        //Return a hash of objects (key=ObjectID) with all snapshots for the object
        var snaps_by_oid = {};
        Ext.each(snaps, function(snap){
            var oid = snap.ObjectID || snap.get('ObjectID');
            if (snaps_by_oid[oid] == undefined){
                snaps_by_oid[oid] = [];
            }
            snaps_by_oid[oid].push(snap.getData());
            
        });
        return snaps_by_oid;
    },
    getDateBuckets: function(startDate, endDate, granularity){

        var bucketStartDate = Rally.technicalservices.Toolbox.getBeginningOfMonthAsDate(startDate);
        var bucketEndDate = Rally.technicalservices.Toolbox.getEndOfMonthAsDate(endDate);
       
        var date = bucketStartDate;
        
        var buckets = []; 
        while (date<bucketEndDate && bucketStartDate < bucketEndDate){
            buckets.push(date);
            date = Rally.util.DateTime.add(date,granularity,1);
        }
        return buckets;  
    },
    formatDateBuckets: function(buckets, dateFormat){
            var categories = [];
            Ext.each(buckets, function(bucket){
                categories.push(Rally.util.DateTime.format(bucket,dateFormat));
            });
            categories[categories.length-1] += "*"; 
            return categories; 
    },


});
Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',
    logger: new Rally.technicalservices.Logger(),
    items: [
        {xtype:'container',itemId:'message_box',tpl:'Hello, <tpl>{_refObjectName}</tpl>'},
        {xtype:'container',itemId:'selector_box', layout: {type: 'hbox'}},
    //    {xtype:'container',itemId:'filter_box', layout: {type: 'vbox'}, title: 'Filter by', border: 1, style: {borderColor: 'gray', borderStyle: 'solid'}},
        {xtype:'container',itemId:'display_box'},
        {xtype:'tsinfolink'}
    ],
    defaultField: 'ScheduleState',
    cycleFields: [],
    granularityStore: [{
        displayName: 'Month',
        value: 'month',
        dateFormat: 'M yyyy',
        tickInterval: 1
    },{
        displayName: 'Week',
        value: 'week',
        dateFormat: 'M dd yyyy',
        tickInterval: 5
    }],
    dataFilters: [],
    launch: function() {
        this._fetchCycleAndFilterableFields().then({
            scope: this,
            success: function(){
                this.logger.log('Valid fields for cycle and filter time', this.cycleFields, this.filterFields); 
                this._initializeApp(this.cycleFields);
            }
        });
    },
    _initializeApp: function(validFields){
        
        var field_store = Ext.create('Rally.data.custom.Store',{
            data: validFields
        });
        this.logger.log('_initializeApp', validFields);
        
        var cb = this.down('#selector_box').add({
            xtype: 'rallycombobox',
            itemId: 'cb-field',
            store: field_store, 
            valueField: 'ElementName',
            displayField: 'Name',
            fieldLabel:  'Field',
            labelAlign: 'right',
            labelWidth: 50,
            margin: 10,
            scope: this,
            listeners: {
                scope: this,
                select: this._updateDropdowns
            }
        });
     //   this._addFilter(validFields);
        
        cb.setValue(this.defaultField);
        this._updateDropdowns(cb);
    },
    _getGroupPrecedence: function(){
        var data = this.down('#cb-from-state').getStore().data;
        var group = [];  
        Ext.each(data.items,function(rec){
            group.push(rec.get('value'));
        });
        this.logger.log('_getGroupPrecedence',group);
        return group;  
    },
    _fetchCycleAndFilterableFields: function(){
        var deferred = Ext.create('Deft.Deferred');
        var allowed_attribute_types = ['STATE','STRING'];
        var additional_filterable_fields = ['PlanEstimate'];
        var valid_fields = [];
        var filter_fields = [];
        /**
         * Right now, this is only getting fields from a story type, but 
         * we need to load fields from a defect type, too.
         */
        var filters = Ext.create('Rally.data.wsapi.Filter',{
            property: 'TypePath',
            value: 'HierarchicalRequirement'
        });
        Ext.create('Rally.data.wsapi.Store',{
            model:  'TypeDefinition',
            filters: filters,
            autoLoad: true,
            fetch: ['Attributes','Name'],
            listeners: {
                scope: this, 
                load: function(store,records,success){
                    this.logger.log('TypeDefinitions loaded success', success, store, records);
                    var attributeStore = records[0].getCollection('Attributes').load({
                        fetch: ['AttributeType','Constrained','Name','ElementName','AllowedQueryOperators', 'RealAttributeType','Type','VisibleOnlyToAdmins','ReadOnly','AllowedValues'],
                        autoLoad: true, 
                        scope: this,
                        callback: function(records, operation, success){
                            this.logger.log('Attributes loaded success',success, operation, records);
                            Ext.each(records, function(rec){
                                var data = rec.getData();
                                if ((data.Constrained  && Ext.Array.contains(allowed_attribute_types, data.AttributeType) && data.ReadOnly == false)){
                                    filter_fields.push(rec);
                                    valid_fields.push(rec);
                                } else {
                                    if (Ext.Array.contains(additional_filterable_fields, data.ElementName)){
                                        filter_fields.push(rec);
                                    }
                                }
                            });
                            this.filterFields = filter_fields;  
                            this.cycleFields = valid_fields; 
                            deferred.resolve();
                        }
                    });
                }
            }
        });
        return deferred;  
    },
    _updateDropdowns: function(cb){
        
        if (this.down('#cb-from-state')){
            this.down('#cb-from-state').destroy();
            this.down('#cb-to-state').destroy();
            this.down('#cb-granularity').destroy();
            this.down('#btn-update').destroy();
            this.down('#btn-filter').destroy();
        }
        
        var field = cb.getValue(); 
        this.down('#selector_box').add({
            xtype: 'rallyfieldvaluecombobox',
            itemId: 'cb-from-state',
            model: 'HierarchicalRequirement',
            field: field,
            allowNoEntry: true,
            noEntryText: '-- Artifact Creation --',
            noEntryValue: null,
            fieldLabel:  'Start',
            labelAlign: 'right',
            labelWidth: 50,
            margin: 10
        });
        
        this.down('#selector_box').add({
            xtype: 'rallyfieldvaluecombobox',
            itemId: 'cb-to-state',
            model: 'HierarchicalRequirement',
            field: field,
            fieldLabel:  'End',
            labelAlign: 'right',
            labelWidth: 50,
            margin: 10
        });
        
        var granularity_store = Ext.create('Rally.data.custom.Store', {
            data: this.granularityStore
        });
        this.down('#selector_box').add({
            xtype: 'rallycombobox',
            itemId: 'cb-granularity',
            store: granularity_store,
            displayField: 'displayName',
            valueField: 'value',
            fieldLabel:  'Granularity',
            labelAlign: 'right',
            labelWidth: 75,
            margin: 10
        });
        
        this.down('#selector_box').add({
            xtype: 'rallybutton',
            itemId: 'btn-update',
            text: 'Update',
            scope: this,
            margin: 10,
            handler: this._createChart
        });
        
        this.down('#selector_box').add({
            xtype: 'rallybutton',
            itemId: 'btn-filter',
            scope: this,
            text: 'Filter',
            margin: 10,
            handler: this._filter
        });
    },
    _getStartState: function(){
        return this.down('#cb-from-state').getValue();
    },
    _getEndState: function(){
        return this.down('#cb-to-state').getValue();
    },
    _getGranularityRecord: function(){
        this.logger.log('_getGranularity', this.down('#cb-granularity').getValue());
        return this.down('#cb-granularity').getRecord();
    },
    _createChart: function(){
        var field = this.down('#cb-field').getValue();
        var granularity_rec = this._getGranularityRecord();
        var granularity = granularity_rec.get('value');  
        var title_text = 'Average Cycle Time from ' + this._getStartState() + ' to ' + this._getEndState();
        var tick_interval = granularity_rec.get('tickInterval');  
        var end_date = new Date(); 
        var start_date = Rally.util.DateTime.add(new Date(),"month",-12);
        var start_state = this._getStartState();
        var filters = this.dataFilters;  
        
        this.logger.log('_createChart', field, start_state, this._getEndState(), granularity, start_date, end_date);
        
//        if (!this._validateSelectedStates()){
//            alert('The From State must come before the To State.');
//            return;
//        }
        
        if (this.down('#rally-chart')){
            this.down('#rally-chart').destroy();
        }
        
        this.down('#display_box').add({
            xtype: 'rallychart',
            itemId: 'rally-chart',
            calculatorType: 'CycleCalculator',
            storeType: 'Rally.data.lookback.SnapshotStore',
            storeConfig: this._getStoreConfig(start_state),
            calculatorConfig: {
                cycleField: field,
                cycleStartValue: start_state,
                cycleEndValue: this._getEndState(),
                cyclePrecedence: this._getGroupPrecedence(),
                startDate: start_date,
                endDate: end_date,
                granularity: granularity,
                dateFormat: granularity_rec.get('dateFormat'),
                dataFilters: filters
            }, 
            chartConfig: {
                chart: {
                    zoomType: 'xy',
                    type: 'line'
                },
                title: {
                    text: title_text
                },
                xAxis: {
                    tickInterval: tick_interval,
                    title: {
                        text: 'Date Entered ' + this._getEndState()
                    }
                },
                yAxis: [
                    {
                        title: {
                            text: 'Days'
                        },
                        min: 0
                    }
                ],
                plotOptions: {
                    series: {
                        marker: {
                            enabled: false
                        }
                    },
                    line: {
                        connectNulls: true
                    }
                },
            }
        });
    },
    _getStoreConfig: function(){
        var start_state = this._getStartState();
        var end_state = this._getEndState(); 
        
        var field = this.down('#cb-field').getValue();
        var prev_field = Ext.String.format('_PreviousValues.{0}', field);
        var fetch = this._getFetchFields();

        var start_date = Rally.util.DateTime.add(new Date(), "Month", -12);
        
        var find = {
                "Children": null,
                "_TypeHierarchy": {$in: ['HierarchicalRequirement','Defect']}
            };
        
        if (this.getContext().getProjectScopeDown()){
            find["_ProjectHierarchy"] = {$in: [this.getContext().getProject().ObjectID]};
        } else {
            find["Project"]= this.getContext().getProject().ObjectID;
        }
        
        var store_config = {
             find: find,
             fetch: fetch,
             hydrate: ['ScheduleState', '_TypeHierarchy'],
             compress: true,
             sort: {
                 _ValidFrom: 1
             },
             context: this.getContext().getDataContext(),
             limit: 'Infinity',
             removeUnauthorizedSnapshots: true
         };

        return store_config;
    },
    _getFetchFields: function(){
        var field = this.down('#cb-field').getValue();
        var fetch_fields = ['ObjectID',field,'_TypeHierarchy','_SnapshotNumber'];
        
        var filter_fields = [];  
        Ext.each(this.dataFilters, function(f){
            if (f.property != field){
                filter_fields.push(f.property);
            }
        },this);
        this.logger.log('_getFetchFields', Ext.Array.merge(fetch_fields,filter_fields));
        return Ext.Array.merge(fetch_fields,filter_fields);
    },
    _filter: function(){
        Ext.create('Rally.technicalservices.dialog.Filter',{
            validFields: this.filterFields,
            listeners: {
                scope: this,
                customFilter: function(filters){
                    this.logger.log('_filter event fired',filters);
                    this.dataFilters = filters;
                    this._createChart();
                    
                }
            }
        });
        
    }
});
            
               Rally.launchApp('CustomApp', {
                   name: 'Filtered Cycle Time'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>